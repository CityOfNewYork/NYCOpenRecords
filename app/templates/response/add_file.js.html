<script type="text/javascript">
    $(function () {
        var form = $(".fileupload-form");
        var first = form.find(".first");
        var second = form.find(".second");
        var third = form.find(".third");

        var next1 = first.find(".next");
        var next2 = second.find(".next");
        var prev2 = second.find(".prev");
        var prev3 = third.find(".prev");

        var addFile = first.find("#add-files");
        var errorMessage = first.find(".fileupload-error-messages");

        // Apply parsley required validation
        addFile.attr('data-parsley-required', 'false');

        // Apply parsley error message to a specific container
        addFile.attr('data-parsley-errors-container', '.fileupload-buttonbar');

        // Handles click events on the first next button
        next1.click(function (e) {
            // Validate file input field and file form
            form.parsley().validate();

            // Removes parsley validator on file input field when a file has been successfully uploaded
            if (first.find(".template-download").length > 0) {
                addFile.attr('data-parsley-required', 'false');
            }

            // Prevent default if one more more upload has not been completed
            if (first.find(".template-download").length === 0 && (first.find(".template-upload").length != 0)) {
                errorMessage.html("<div class='alert alert-danger'>One or more uploads has not completed</div>");
                e.preventDefault();
                return false;
            }

            // Prevent default if no file has been added or uploaded
            if (first.find(".template-download").length === 0 && (first.find(".template-upload").length === 0)) {
                errorMessage.html("<div class='alert alert-danger'>A file must be added</div>");
                e.preventDefault();
                return false;
            }

            // Prevent default if files with error are not removed
            if ($('.upload-error').length > 0 || $(".error-post-fileupload").is(':visible')) {
                errorMessage.html("<div class='alert alert-danger'>Files with Errors must be removed</div>");
                e.preventDefault();
                return false;
            }

            // Prevent default if fileupload form is in NOT valid
            if (!form.parsley().isValid()) {
                e.preventDefault();
                return false;
            }

            // Proceed with next click function if validation fields are valid and no files are uploading
            if (form.parsley().isValid() && (first.find(".template-upload").length === 0)) {
                errorMessage.html('');
                var privacy = $(".file-privacy:checked").map(function(){return $(this).val(); }).get();
                var is_private;
                for (var i = 0; i < privacy.length; i++) {
                    // 1. Check if current value === 'private'
                    if (privacy[i] === 'private') {
                        is_private = true;
                    } else {
                        is_private = false;
                        break;
                    }
                }
                console.log(is_private);
                $.ajax({
                    url: "/response/email",
                    type: 'POST',
                    data: {
                        request_id: "{{ request.id }}",
                        template_name: "email_response_file.html",
                        type: "files",
                        is_private: is_private
                    },
                    success: function (data) {
                        // Data should be html template page.
                        tinyMCE.get('email-file-content').setContent(data.template);
                    }
                });
                first.hide();
                second.show();
            }
        });

        // Handles click events on the second next button
        next2.click(function () {
            $('.fileupload-error-messages').html('');
            tinyMCE.triggerSave();

            // Create an array (called files) of objects with keys of filename and privacy
            var files = [];
            for( var i = 0; i < filenames.length; i++ ) {
                var file = {};
                file["filename"] = filenames[i];
                file["privacy"] = privacy[i];

                files.push(file);
            }

            $.ajax({
                url: "/response/email",
                type: 'POST',
                data: {
                    request_id: "{{ request.id }}",
                    template_name: "email_response_file.html",
                    type: "files",
                    files: JSON.stringify(files),
                    email_content: $('#email-file-content').val()
                },
                success: function (data) {
                    // Data should be html template page.
                    $("#email-file-summary").html(data.template);
                    $("#email-file-summary-hidden").val(data.template);
                }
            });
            second.hide();
            third.show();
        });

        // Handles click events on the first previous button
        prev2.click(function () {
            $('.fileupload-error-messages').html('');
            second.hide();
            first.show();
        });

        // Handles click events on the second previous button
        prev3.click(function () {
            third.hide();
            second.show();
        });

        // Disable button on submit click and submit form
        $("#file-submit").click(function () {
            $(this).attr("disabled", true);
            $("#fileupload").submit();
        });

        // Initialize tinymce HTML editor
        tinymce.init({
            menubar: false,
            // sets tinymce to enable only on specific textareas classes
            mode: "specific_textareas",
            // selector for tinymce textarea classes is set to 'tinymce-area'
            editor_selector: "tinymce-area",
            elementpath: false,
            convert_urls: false,
            height: 180
        });
    });
</script>
