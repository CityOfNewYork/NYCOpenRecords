<script type="text/javascript">
    $(document).ready(function () {
        // Hides all other divs except for the first. Also hides previous button on the first div.
        $(".fileupload-control .fileupload-divs").each(function (e) {
            if (e != 0)
                $(this).hide();
            else
                $("#previous").hide();
        });

        // Handles click events on the first next button
        $("#fileupload-next-1").click(function (e) {
            // Validate file input field and file form
            $('#fileupload').parsley().validate();

            // Removes parsley validator on file input field when a file has been successfully uploaded
            if ($('.template-download').length > 0) {
                $('#add-files').attr('data-parsley-required', 'false');
            }

            // Prevent default if one more more upload has not been completed
            if ($('.template-download').length === 0 && ($('.template-upload').length != 0)) {
                $('.fileupload-error-messages').html("<div class='alert alert-danger'>One or more uploads has not completed</div>");
                e.preventDefault();
                return false;
            }

            // Prevent default if no file has been added or uploaded
            if ($('.template-download').length === 0 && ($('.template-upload').length === 0)) {
                $('.fileupload-error-messages').html("<div class='alert alert-danger'>A file must be added</div>");
                e.preventDefault();
                return false;
            }

            if ($('.upload-error').length > 0 || $(".error-post-fileupload").is(':visible')) {
                $('.fileupload-error-messages').html("<div class='alert alert-danger'>Files with Errors must be removed</div>");
                e.preventDefault();
                return false;
            }

            // Prevent default if fileupload form is in NOT valid
            if (!$('#fileupload').parsley().isValid()) {
                e.preventDefault();
                return false;
            }

            // Proceed with next click function if validation fields are valid and no files are uploading
            if ($("#fileupload").parsley().isValid() && ($('.template-upload').length === 0)) {
                $(".fileupload-error-messages").hide();
                var formData = {
                    request_id: "{{ request.id }}",
                    template_name: "email_file_upload.html",
                    type: "file_upload_email",
                };

                $.ajax({
                    url: "/response/email",
                    type: 'POST',
                    data: JSON.stringify(formData),
                    contentType: false,
                    success: function (data) {
                        // Data should be html template page.
                        tinyMCE.get('email-file-content').setContent(data);
                    }
                });
                document.getElementById("first").style.display = "none";
                document.getElementById("second").style.display = "block";
            }
        });

        // Handles click events on the second next button
        $("#fileupload-next-2").click(function () {
            tinyMCE.triggerSave();

            var filenames = $('.secured-name').map( function(){return $(this).text(); }).get();
            var privacy = $('input[type="radio"]:checked').map( function(){return $(this).val(); }).get();

            var files = [];

            for( var i = 0; i < filenames.length; i++ ) {
                file = {};
                file["filename"] = filenames[i];
                file["privacy"] = privacy[i];

                files.push(file);
            }

            console.log(files);


            var formData = {
                    request_id: "{{ request.id }}",
                    template_name: "email_file_upload.html",
                    type: "file_upload_email",
                    files: files,
                    email_content: $('#email-file-content').val()
                };

                $.ajax({
                    url: "/response/email",
                    type: 'POST',
                    data: JSON.stringify(formData),
                    contentType: false,
                    success: function (data) {
                        // Data should be html template page.
                        $("#email-file-summary").html(data);
                        $("#email-file-summary-hidden").val(data);
                    }
                });
            document.getElementById("second").style.display = "none";
            document.getElementById("third").style.display = "block";

        });

        // Handles click events on the first previous button
        $("#fileupload-prev-1").click(function () {
            document.getElementById("first").style.display = "block";
            document.getElementById("second").style.display = "none";
        });

        // Handles click events on the second previous button
        $("#fileupload-prev-2").click(function () {
            document.getElementById("third").style.display = "none";
            document.getElementById("second").style.display = "block";
        });

{#        document.getElementById("email-file-summary-hidden").value = document.getElementById("email-file-summary").innerHTML;#}
{#        $('#email-file-summary-hidden').val($('#email-file-summary').innerHTML);#}
{#        $('#email-file-summary-hidden').val($('#email-file-summary').text());#}

        // Apply parsley required validation
        $('#add-files').attr('data-parsley-required', '');
        $('#add-files').attr('data-parsley-required-message', 'A file must be added.');

        // Apply parsley error message to a specific container
        $('#add-files').attr('data-parsley-errors-container', '.fileupload-buttonbar');
    });
</script>
